cmake_minimum_required(VERSION 3.10)

project(RenderX VERSION 1.0)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ───── External Libraries ──────────────────────────────────────────
add_subdirectory(External/glm)
add_subdirectory(External/spdlog)
add_subdirectory(External/glew-2.1.0/build/cmake)
add_subdirectory(External/glfw)
add_subdirectory(test)

# ───── Source Files ────────────────────────────────────────────────
file(GLOB_RECURSE SOURCES
    "${CMAKE_SOURCE_DIR}/src/RenderX/*.cpp"
    "${CMAKE_SOURCE_DIR}/src/RenderX/*.h"
    "${CMAKE_SOURCE_DIR}/src/Backend/OpenGL/*.cpp"
    "${CMAKE_SOURCE_DIR}/src/Backend/OpenGL/*.h"
    "${CMAKE_SOURCE_DIR}/src/Backend/Vulkan/*.cpp"
    "${CMAKE_SOURCE_DIR}/src/Backend/Vulkan/*.h"
)

# ───── Create RenderX Library (Shared DLL) ──────────────────────────
add_library(${PROJECT_NAME} SHARED ${SOURCES})

target_compile_definitions(${PROJECT_NAME} PRIVATE RENDERX_BUILD_DLL)

target_include_directories(${PROJECT_NAME}
    PUBLIC  "${CMAKE_SOURCE_DIR}/src"
    PUBLIC  "${CMAKE_SOURCE_DIR}/External/glm"
    PRIVATE "${CMAKE_SOURCE_DIR}/External/spdlog/include"
    PRIVATE "${CMAKE_SOURCE_DIR}/External/glew-2.1.0/include"
    PRIVATE "${CMAKE_SOURCE_DIR}/External/glfw/include"
)

target_link_libraries(${PROJECT_NAME}
    PRIVATE glm
    PRIVATE spdlog
    PRIVATE glew_s       # static glew
    PRIVATE glfw
)

# ───── Copy Dependencies (DLLs) Next to RenderX.dll ─────────────────
# If glew/glfw build DLLs, we copy them automatically

# NOTE: Replace library1lib with the correct target name if needed
# EXAMPLE: if you want to copy GLEW or GLFW DLLs, use:
# "$<TARGET_FILE:glew>" or "$<TARGET_FILE:glfw>"

# REMOVE your incorrect part and use this instead:
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E echo "Copying RenderX dependencies..."
)

# Copy RenderX.dll to the test folder after build
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
        "$<TARGET_FILE:${PROJECT_NAME}>"
        "${CMAKE_BINARY_DIR}/test"
)

# Example: Copy GLEW DLL (if it's shared)
if (TARGET glew)
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "$<TARGET_FILE:glew>"
            "$<TARGET_FILE_DIR:${PROJECT_NAME}>"
    )
endif()

# Example: Copy GLFW DLL (if it's shared)
if (TARGET glfw)
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "$<TARGET_FILE:glfw>"
            "$<TARGET_FILE_DIR:${PROJECT_NAME}>"
    )
endif()
